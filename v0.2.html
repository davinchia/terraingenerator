<!DOCTYPE html>
<html lan="en">

	<head>
		<title>HeightField</title>
		<script type="text/javascript" src="../lib/webgl-utils.js"></script>
		<script type="text/javascript" src="../lib/MV.js"></script>
		<script type="text/javascript" src="../lib/InitShaders.js"></script>
		
		<script type="text/javascript" src="test.js"></script>
		
		<script id="vertex-shader" type="x-shader/x-vertex">
			attribute vec4 a_Position;
			attribute vec3 a_Color;
			attribute vec3 a_Normal;
			vec4 vertexPos;
			vec3 vertexNorm;

			uniform mat4 u_Projection;
			uniform mat4 u_ViewMatrix;
			uniform mat4 u_ModelMatrix;
			uniform vec3 u_light_Dir;
			
			varying vec3 v_Color;
			varying vec3 v_Position;
			varying vec3 v_Normal;
			varying vec3 v_LD;

			//for water
			uniform float u_waterLine;
			
			void main()	{
				v_Color = a_Color;
				vertexPos = a_Position;
				vertexNorm = a_Normal;

				//modify for waters
				if (a_Position.y < u_waterLine) {
					v_Color = vec3(0.0, 0.0, 0.2);	//set to blue
					vertexPos.y = u_waterLine;
					vertexNorm = vec3(0,1,0);
				}

				gl_Position = u_Projection* u_ViewMatrix* u_ModelMatrix* vertexPos;
				gl_PointSize = 5.0;

				v_LD = mat3(u_ViewMatrix*u_ModelMatrix) * u_light_Dir;
				v_LD = mat3(u_ViewMatrix) * u_light_Dir;
				v_LD = u_light_Dir;
				v_Position = (u_ViewMatrix*u_ModelMatrix*vertexPos).xyz;
				v_Normal = mat3(u_ViewMatrix*u_ModelMatrix)*vertexNorm;

			}
		</script>
		
		<script id="fragment-shader" type="x-shader/x-fragment">
			precision highp float;
			
			varying vec3 v_Color;
			varying vec3 v_Position;
			varying vec3 v_Normal;
			varying vec3 v_LD;
			
			//following are for light
			uniform vec3 u_light_Color;
			uniform vec3 u_light_Dir;
			uniform vec3 u_light_Ambient;
			uniform vec3 u_light_Diffuse;
			uniform vec3 u_light_Specular;
			uniform float u_Shininess;

			vec3 L, N, V, H, P;
			vec3 ambient = vec3(0,0,0); 
			vec3 diffuse = vec3(0,0,0); 
			vec3 specular = vec3(0,0,0);
			vec4 finalColor;

			//for fog
			const float LOG2 = 1.442695;
			float fog_Density = 0.008;
			float perspective = 3000.0;
			float fog_Coord;
			float fog;
			vec4 fog_Color = vec4(0.005,0.005,0.005,0);

			void main()	{
					P = v_Position;
					N = normalize(v_Normal);
					L = normalize(v_LD);
					V = normalize( -P);
					H = normalize(L+V);

					ambient = u_light_Color * u_light_Ambient;
					diffuse = u_light_Color * max(dot(L, N), 0.0)* u_light_Diffuse;
					//note that we remove specular because the terrain we model is not reflective
					
					//fog calculations
					fog_Coord = (gl_FragCoord.z/gl_FragCoord.w);
					fog = exp2(-fog_Density * fog_Density * fog_Coord * fog_Coord * LOG2);
					fog = clamp(fog, 0.0, 1.0);
					
					finalColor = vec4((ambient + diffuse + specular) * v_Color, 1.0);
					//gl_FragColor = mix(fog_Color, finalColor, fog);
					gl_FragColor = finalColor;

			}
		</script>
		
		<style type="text/css">
			canvas {
				border: 1px solid black;
			}

			input {
				width: 30px;
			}

			#instruct {
				vertical-align: top;
				width: 40%;
				margin-top: 50px;
				display: inline-block;
				padding-left: 50px;
			}

		</style>
	</head>
	<body>
		<canvas id="gl-canvas" width="640" height="640">
			You need a better web browser
		</canvas>

		<div id="instruct">
				<h1>The Misty Mountains! (With way more water and no dragon)</h1>
				<ul>
					Instructions:
					<li>Use the <span style="color:red">right arrow button</span> to move the camera right.</li>
					<li>Use the <span style="color:red">left arrow button</span> to move the camera left.</li>
					<li>Use the <span style="color:red">up arrow button</span> to move the camera forward.</li>
					<li>Use the <span style="color:red">down arrow button</span> to move the camera back.</li>
					<li>Use the <span style="color:red">w</span> key to look up.</li>
					<li>Use <span style="color:red">s</span> key to look down.</li>
					<li>Use the <span style="color:red">a</span> key to look left.</li>
					<li>Use <span style="color:red">d</span> key to look right.</li>
					<li>Use the <span style="color:red">q</span> key to descend.</li>
					<li>Use <span style="color:red">e</span> key to ascend.</li>
					<li>If you get tired, don't worry! Many say the Misty Mountains go on infinitely...</li>
				</ul>
			</div>
	</body>
</html>